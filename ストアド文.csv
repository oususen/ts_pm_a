Procedure,sql_mode,"Create Procedure",character_set_client,collation_connection,"Database Collation"
recompute_shipped_remaining_by_product,"ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION","CREATE DEFINER=`root`@`localhost` PROCEDURE `recompute_shipped_remaining_by_product`(
    IN p_product_id INT,
    IN p_start_date DATE,
    IN p_end_date   DATE
)
BEGIN
    DECLARE v_prev INT DEFAULT 0;

    START TRANSACTION;

    -- 初期値：開始前日の残（無ければ0）。同日複数行があっても1件だけ参照
    SELECT COALESCE(shipped_remaining_quantity, 0)
      INTO v_prev
      FROM delivery_progress
     WHERE product_id    = p_product_id
       AND delivery_date = DATE_SUB(p_start_date, INTERVAL 1 DAY)
     ORDER BY id
     LIMIT 1
     FOR UPDATE;

    -- 対象期間の行をロック
    SELECT 1
      FROM delivery_progress
     WHERE product_id   = p_product_id
       AND delivery_date BETWEEN p_start_date AND p_end_date
     FOR UPDATE;

    -- 日合算テーブル
    DROP TEMPORARY TABLE IF EXISTS tmp_day_totals_sr;
    CREATE TEMPORARY TABLE tmp_day_totals_sr (
        delivery_date DATE PRIMARY KEY,
        order_total   INT NOT NULL DEFAULT 0,
        shipped_total INT NOT NULL DEFAULT 0,
        day_sr        INT NULL  -- 当日の shipped_remaining_quantity
    ) ENGINE=Memory;

    INSERT INTO tmp_day_totals_sr (delivery_date, order_total, shipped_total)
    SELECT
        dp.delivery_date,
        COALESCE(SUM(dp.order_quantity),   0) AS order_total,
        COALESCE(SUM(dp.shipped_quantity), 0) AS shipped_total
    FROM delivery_progress dp
    WHERE dp.product_id = p_product_id
      AND dp.delivery_date BETWEEN p_start_date AND p_end_date
    GROUP BY dp.delivery_date
    ORDER BY dp.delivery_date;

    -- 連鎖計算：前日残 + shipped − order
    BEGIN
        DECLARE done INT DEFAULT 0;
        DECLARE v_date  DATE;
        DECLARE v_order INT;
        DECLARE v_ship  INT;

        DECLARE cur CURSOR FOR
            SELECT delivery_date, order_total, shipped_total
              FROM tmp_day_totals_sr
             ORDER BY delivery_date;

        DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

        OPEN cur;
        day_loop: LOOP
            FETCH cur INTO v_date, v_order, v_ship;
            IF done = 1 THEN LEAVE day_loop; END IF;

            SET v_prev = v_prev + COALESCE(v_ship,0) - COALESCE(v_order,0);

            UPDATE tmp_day_totals_sr
               SET day_sr = v_prev
             WHERE delivery_date = v_date;
        END LOOP;
        CLOSE cur;
    END;

    -- 実テーブルへ当日値を反映（同日の全レコードに同値）
    UPDATE delivery_progress dp
    JOIN tmp_day_totals_sr t
      ON dp.delivery_date = t.delivery_date
     AND dp.product_id    = p_product_id
       SET dp.shipped_remaining_quantity = t.day_sr
    WHERE dp.delivery_date BETWEEN p_start_date AND p_end_date;

    COMMIT;
END",utf8mb4,utf8mb4_0900_ai_ci,utf8mb4_unicode_ci
