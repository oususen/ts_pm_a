# トラック積載計画 - 新ルール実装ガイド

## 📋 実装概要

`domain/calculators/transport_planner.py` を新しいルールに基づいて完全に再設計しました。

---

## 🎯 新ルールの詳細

### **基本設定**

1. **底面積ベースの計算**
   - 従来の体積計算ではなく、容器とトラックの底面積（幅×奥行）で計算
   - 高さは考慮しない（積み重ねは別途管理）
   - **段積み対応**: 同じ容器は段積み可能（`max_stack`で指定）

2. **トラック構成**
   - デフォルト3台: 通常使用するトラック
   - 非デフォルト1台: 需要が多い場合のみ使用

3. **前倒し制限**
   - 前倒しは1日前のみ可能
   - 例: 10/10分 → 10/9可、10/8不可

4. **優先積載製品**
   - トラックマスタに `priority_product_codes` カラムを使用
   - カンマ区切りで製品コードを指定（例: "P001,P002"）

---

## 📦 段積み計算ロジック

### **段積み可能条件**
- 容器マスタの `stackable` が `True`
- 容器マスタの `max_stack` が 2 以上

### **底面積計算式**

#### **段積みなしの場合**
```
底面積 = 容器の底面積 × 容器数
```

#### **段積みありの場合**
```
実際の容器配置数 = ⌈容器数 ÷ max_stack⌉
底面積 = 容器の底面積 × 実際の容器配置数
```

### **計算例**

**例1: 段積み2段の場合**
```
製品: P001
容器: F_K (1760mm × 1150mm, max_stack=2)
数量: 56個
capacity: 8個/容器

容器数 = ⌈56 ÷ 8⌉ = 7容器
実際の配置数 = ⌈7 ÷ 2⌉ = 4配置（2段×3 + 1段×1）
底面積 = 1760 × 1150 × 4 = 8,096,000 mm²
```

**例2: 段積みなしの場合**
```
製品: P002
容器: R_B (1030mm × 830mm, max_stack=1)
数量: 24個
capacity: 6個/容器

容器数 = ⌈24 ÷ 6⌉ = 4容器
実際の配置数 = 4配置（段積みなし）
底面積 = 1030 × 830 × 4 = 3,419,200 mm²
```

---

## 🔄 計画作成プロセス

### **Step1: 需要分析とトラック台数決定**

```python
def _analyze_demand_and_decide_trucks(...)
```

**処理内容:**
1. 全受注の底面積を計算
2. 日平均積載量を算出
3. デフォルト3台の総底面積と比較
4. 平均量が超過する場合、非デフォルトトラックを使用

**判定ロジック:**
```python
avg_floor_area = total_floor_area / len(working_dates)
use_non_default = avg_floor_area > default_total_floor_area
```

---

### **Step2: 前倒し処理（最終日から逆順）**

```python
def _forward_scheduling(...)
```

**処理内容:**
1. 最終日から順に各日の積載量をチェック
2. トラック能力を超過する場合、超過分を前日に前倒し
3. 前倒し分は前日の積載対象に追加

**重要ポイント:**
- 最終日から逆順に処理することで、前倒しの連鎖を防止
- 1日前のみ前倒し可能（2日以上前には移動しない）

**例:**
```
元の計画:
  10/10: 底面積 150㎡（超過50㎡）
  10/09: 底面積 80㎡

前倒し後:
  10/10: 底面積 100㎡
  10/09: 底面積 130㎡（50㎡追加）
```

---

### **Step3: 日次積載計画作成**

```python
def _create_daily_loading_plan(...)
```

**積載優先順位:**

#### **3-1. 優先積載製品**
```python
def _load_priority_products(...)
```
- トラックの `priority_product_codes` に指定された製品を優先的に積載
- 例: トラックNO_4_10T の優先製品が "P001" の場合、P001を最優先

#### **3-2. 同容器の製品**
```python
def _load_same_container_products(...)
```
- 既に積載した製品と同じ容器を使用する製品を積載
- 製品の分散を防止し、積載効率を向上

**例:**
```
トラックNO_4_10T:
- 優先製品: P001（F_K容器）18台 ← 優先積載
- 残り空間: F_K容器×2台分
- 候補:
  - P002（F_K容器）2台 ← 同容器なので選択
  - P003（F_K容器）10台
  - P004（G_L容器）5台
→ P002を積載
```

#### **3-3. 異容器の製品**
```python
def _load_other_products(...)
```
- 余裕があれば異なる容器の製品も積載

---

### **Step4: 非デフォルトトラック活用**

**条件:**
- Step1で `use_non_default = True` と判定された場合のみ
- 非デフォルトトラックの `arrival_day_offset` は通常1日

**動作:**
```python
if use_non_default:
    available_trucks = [(tid, t) for tid, t in truck_map.items()]
else:
    available_trucks = [(tid, t) for tid, t in truck_map.items() 
                       if t.get('default_use', False)]
```

---

## 📊 データ構造

### **入力データ**

#### **トラックマスタ (truck_master)**
```sql
CREATE TABLE truck_master (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50),
    width INTEGER,           -- mm
    depth INTEGER,           -- mm
    height INTEGER,          -- mm
    default_use BOOLEAN,     -- デフォルト使用フラグ
    arrival_day_offset INTEGER,  -- 到着日オフセット
    priority_product_codes VARCHAR(255)  -- 優先積載製品（カンマ区切り）
);
```

**例:**
```csv
id,name,width,depth,height,default_use,arrival_day_offset,priority_product_codes
1,トラックNO_4_10T,2200,4500,2500,TRUE,0,"P001,P002"
2,トラックNO_5_10T,2200,4500,2500,TRUE,0,"P003"
3,トラックNO_6_10T,2200,4500,2500,TRUE,0,""
4,トラックNO_7_4T,1800,3500,2000,FALSE,1,""
```

#### **容器マスタ (container_capacity)**
```sql
CREATE TABLE container_capacity (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50),
    width INTEGER,   -- mm
    depth INTEGER,   -- mm
    height INTEGER   -- mm
);
```

---

### **出力データ**

#### **日次積載計画**
```python
{
    'daily_plans': {
        '2025-10-10': {
            'trucks': [
                {
                    'truck_id': 1,
                    'truck_name': 'トラックNO_4_10T',
                    'loaded_items': [
                        {
                            'product_code': 'P001',
                            'num_containers': 18,
                            'floor_area': 18000000,  # mm²
                            'floor_area_per_container': 1000000
                        }
                    ],
                    'utilization': {
                        'floor_area_rate': 95.5,
                        'volume_rate': 95.5,
                        'weight_rate': 0
                    }
                }
            ],
            'total_trips': 1,
            'warnings': []
        }
    },
    'summary': {
        'total_days': 7,
        'total_trips': 15,
        'total_warnings': 0,
        'use_non_default_truck': False,
        'status': '正常'
    }
}
```

---

## 🔧 設定方法

### **1. トラックマスタの設定**

#### **優先積載製品の設定**
```sql
UPDATE truck_master 
SET priority_product_codes = 'P001,P002,P003'
WHERE id = 1;
```

#### **デフォルト使用フラグの設定**
```sql
-- デフォルトトラック（3台）
UPDATE truck_master SET default_use = TRUE WHERE id IN (1, 2, 3);

-- 非デフォルトトラック（1台）
UPDATE truck_master SET default_use = FALSE WHERE id = 4;
```

---

### **2. 製品マスタの設定**

#### **使用トラックの設定**
```sql
UPDATE products 
SET used_truck_ids = '1,2,3'  -- 優先順位付き
WHERE product_code = 'P001';
```

---

## 📈 計算例

### **シナリオ**
- 計画期間: 10/10 ~ 10/16 (7営業日)
- デフォルトトラック3台: 各10㎡ = 合計30㎡
- 総需要: 200㎡
- 日平均: 200㎡ ÷ 7日 = 28.6㎡

### **Step1: 需要分析**
```
日平均 28.6㎡ < デフォルト能力 30㎡
→ use_non_default = False（非デフォルトトラック不使用）
```

### **Step2: 前倒し処理**
```
10/16: 35㎡（超過5㎡） → 10/15に5㎡前倒し
10/15: 30㎡ → OK
10/14: 28㎡ → OK
...
```

### **Step3: 日次積載計画**
```
10/10:
  トラック1: 優先製品P001（8㎡）+ 同容器P002（2㎡）= 10㎡
  トラック2: 優先製品P003（9㎡）= 9㎡
  トラック3: 製品P004（9㎡）= 9㎡
  合計: 28㎡
```

---

## ⚠️ 注意事項

### **1. 底面積の単位**
- データベースは mm 単位
- 計算時は mm² で処理
- 表示時は ㎡ に変換（÷ 1,000,000）

### **2. 1日1便制約**
- 各トラックは1日に1回のみ使用
- 同じトラックが同じ日に複数回出現しない

### **3. 前倒しの制限**
- 1日前のみ前倒し可能
- 製品の `can_advance` フラグは現在未使用（将来拡張用）

### **4. 優先積載製品**
- カンマ区切りで複数指定可能
- 製品コードは完全一致で判定
- 空白は自動的にトリムされる

---

## 🧪 テスト方法

### **1. 基本動作確認**
```python
# アプリを起動
streamlit run main.py

# 配送便計画ページで計画作成
# - 期間選択
# - 計画作成ボタンクリック
# - 結果確認
```

### **2. 非デフォルトトラック使用確認**
```python
# 大量の受注データをインポート
# → 日平均がデフォルト能力を超える
# → 非デフォルトトラックが使用される
```

### **3. 優先積載製品確認**
```python
# トラックマスタで priority_product_codes を設定
# → 該当製品が優先的に積載される
```

---

## 📝 今後の拡張

### **1. 製品分割の最適化**
- 現在: 1製品は1トラックに積載
- 改善案: 大量の製品を複数トラックに分割

### **2. 重量制約の追加**
- 現在: 底面積のみ考慮
- 改善案: 重量制約も追加

### **3. 動的な前倒し日数**
- 現在: 1日前のみ
- 改善案: 製品の `can_advance` フラグで制御

---

## ✅ 実装完了チェックリスト

- [x] 底面積ベースの計算実装
- [x] **段積み対応（同じ容器の段積み計算）**
- [x] デフォルト/非デフォルトトラック判定
- [x] 前倒し処理（最終日から逆順）
- [x] 優先積載製品の実装
- [x] 同容器製品の優先積載
- [x] 1日1便制約の維持
- [x] 互換性の確保（既存インターフェース維持）

---

## 🔗 関連ファイル

- **計算ロジック**: `domain/calculators/transport_planner.py`
- **データモデル**: `domain/models/transport.py`
- **サービス層**: `services/transport_service.py`
- **UI**: `ui/pages/transport_plan_page.py`

---

**実装日**: 2025-10-10  
**バージョン**: 2.0
