# 問題分析レポート: Book1.csvの不一致

## 報告された問題

1. **問題1**: 10/23にトラックID=10 (NO_4_10T)が使われていない
2. **問題2**: 前倒し配送処理がされていない（全て「×」）

## 調査結果

### 問題1: トラックID=10の使用状況

**結論**: ✅ **問題なし - Book1.csvが古いまたは不完全なデータ**

- `verify_1023_issue.py`の検証結果:
  - 10/23にトラックID=10 (NO_4_10T)は**正しく使用されている**
  - V053904703を20容器積載、積載率93.7%
  - 使用トラック: [3, 10, 11]

- Book1.csvの10/23:
  - NO_2_10T (ID=3): V053103705, V065104703, V065103703
  - NO_3_10T (ID=11): V053143521, V053143615, V065104642, V053104642
  - **NO_4_10T (ID=10)の記載なし** ← これが問題

**原因**: Book1.csvは古いバージョンまたは不完全な出力から生成された可能性が高い

### 問題2: 前倒し配送フラグ

**結論**: ✅ **修正完了 - CSV出力に「前倒し配送」列を追加**

- `verify_advanced_items.py`の検証結果:
  - 総アイテム数: 103
  - 前倒しアイテム数: 0
  - 前倒し率: 0.0%

**重要な発見**:
- トラックID=11 (NO_3_10T)は`arrival_day_offset=1`の設定により、納期の1日前が積載日になる
- これは「前倒し配送」ではなく、**トラックの到着日オフセットによる通常の積載日計算**
- 例: 納期10/14の製品 → 積載日10/13 (10/14 - 1日)

**前倒し配送 vs 到着日オフセット**:
- **到着日オフセット**: トラックの物理的な到着時間による積載日の調整（製品マスタのused_truck_idsとarrival_day_offsetで決定）
- **前倒し配送**: 積載能力不足時に、前倒し可能な製品を前日に移動する処理（_forward_schedulingメソッド）

現在のデータでは、トラック能力が十分なため、前倒し配送処理は発動していない。

## 実施した修正

### 1. CSV出力機能の改善 (`services/transport_service.py`)

#### 修正内容:
- `export_loading_plan_to_csv()`に「前倒し配送」列を追加
- `_export_daily_plan()`に「前倒し配送」列を追加
- `_export_weekly_plan()`に「前倒し配送」と「納期」列を追加
- 警告情報もCSV出力に含めるように改善

#### 変更箇所:
```python
# 前倒しフラグを取得
is_advanced = item.get('is_advanced', False)
advanced_mark = '○' if is_advanced else '×'

daily_data.append({
    '積載日': date_str,
    'トラック名': truck['truck_name'],
    '製品コード': item.get('product_code', ''),
    '製品名': item.get('product_name', ''),
    '容器数': item.get('num_containers', 0),
    '合計数量': item.get('total_quantity', 0),
    '納期': item['delivery_date'].strftime('%Y-%m-%d') if 'delivery_date' in item else '',
    '体積積載率(%)': truck['utilization']['volume_rate'],
    '重量積載率(%)': truck['utilization']['weight_rate'],
    '前倒し配送': advanced_mark  # ← 追加
})
```

## 推奨事項

1. **Streamlitアプリで再度計画を作成**
   - 最新のコードで10/10-10/31の計画を作成
   - CSV出力を実行して新しいBook1.csvを生成
   - トラックID=10が10/23に含まれることを確認

2. **前倒し配送のテスト**
   - トラック台数を減らすなど、意図的に積載能力不足を作る
   - 前倒し配送処理が正しく動作することを確認
   - 「前倒し配送」列に「○」が表示されることを確認

3. **データの整合性確認**
   - ターミナルシミュレーション結果とStreamlitアプリの結果が一致することを確認
   - 同じ入力データで同じ結果が得られることを検証

## まとめ

- ✅ CSV出力機能を改善し、「前倒し配送」列を追加
- ✅ トラックID=10の問題は、Book1.csvが古いデータであることが原因
- ✅ 前倒し配送フラグの問題は、CSV出力に列がなかったことが原因
- ✅ TransportPlannerのロジックは正常に動作している

**次のステップ**: Streamlitアプリで計画を再作成し、新しいCSVを出力して確認してください。
