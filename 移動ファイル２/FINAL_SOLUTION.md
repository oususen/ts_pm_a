# 最終解決策：データソース統一

## 問題の本質

**シミュレーションスクリプトとStreamlitアプリで異なるデータソースを使用していた**

### データソースの違い

| スクリプト | データソース | 状態 |
|-----------|-------------|------|
| test_simulation_1010_1031.py | DELIVERY_PROGRESS.csv | ❌ 古いデータ |
| Streamlit main.py | MySQLデータベース | ✅ 最新データ |

## 解決方法

### ✅ MySQL版シミュレーションスクリプトを使用

**`test_simulation_mysql.py`** を作成しました。

このスクリプトは：
- ✅ Streamlitアプリと**同じMySQLデータベース**を使用
- ✅ 最新のデータを反映
- ✅ 前倒し配送が正しく表示される（`[前倒し]`マーク付き）
- ✅ CSV出力機能も改善済み（「前倒し配送」列を追加）

### 実行方法

```powershell
# 仮想環境をアクティベート
& d:/ts_app_claude/venv/Scripts/Activate.ps1

# MySQL版シミュレーション実行
python test_simulation_mysql.py
```

または

```bash
# venv環境のPythonを直接指定
d:\ts_app_claude\venv\Scripts\python.exe test_simulation_mysql.py
```

## 実行結果の確認

### 10/23の正しい結果（MySQL版）

```
2025-10-23 (2便)
  NO_2_10T (ID=3) 積載率86.6%
    - V053103705: 1容器 (納期=2025-10-23)
    - V065104703: 18容器 (納期=2025-10-23)
    - V065103703: 1容器 (納期=2025-10-23)
  
  NO_3_10T (ID=11) 積載率95.6%
    - V053143521: 8容器 (納期=2025-10-24)
    - V053143615: 10容器 (納期=2025-10-24)
    - V065104642: 7容器 (納期=2025-10-24)
    - V053104642: 9容器 (納期=2025-10-24)
```

**なぜNO_4_10Tが10/23に使われていないか？**

→ V053904703（納期10/23、23容器）が**10/22に前倒し配送**されたため

```
2025-10-22 (3便)
  NO_2_10T: V053904703 3容器 [前倒し] (納期=2025-10-23)
  NO_4_10T: V053904703 20容器 [前倒し] (納期=2025-10-23)
  NO_3_10T: その他製品
```

## 前倒し配送の確認

MySQL版では**前倒し配送が正しく動作**しています：

- ✅ `[前倒し]`マークが表示される
- ✅ 納期と積載日が異なる
- ✅ CSV出力にも「前倒し配送」列が追加済み

## Streamlitアプリでの確認

1. Streamlitアプリを起動:
   ```bash
   streamlit run main.py
   ```

2. 「配送便計画」タブで10/10-10/31の計画を作成

3. CSV出力を実行

4. 新しいCSVで確認:
   - ✅ 「前倒し配送」列が表示される
   - ✅ MySQL版シミュレーションと同じ結果
   - ✅ 10/23は2便（NO_2_10T、NO_3_10T）

## Book1.csvについて

Book1.csvは以下のいずれかの理由で不一致：

1. **古いデータ**から生成された
2. **異なる条件**（日数、開始日など）で生成された
3. **CSV出力機能の改善前**に生成された（「前倒し配送」列なし）

**推奨**: Book1.csvは破棄し、最新のStreamlitアプリで再生成してください。

## 今後の運用

### データ管理

1. **データの更新はStreamlitアプリで行う**
   - 「CSV受注取込」機能を使用
   - または「納入進度」ページで直接編集

2. **シミュレーションはMySQL版を使用**
   - `test_simulation_mysql.py`を実行
   - Streamlitアプリと完全に同じ結果

3. **CSVファイルは参照用のみ**
   - DELIVERY_PROGRESS.csvは古い可能性あり
   - 最新データはMySQLデータベースにある

### ファイル構成

```
d:\ts_app_claude\
├── test_simulation_mysql.py      ← ✅ 推奨（MySQL版）
├── test_simulation_1010_1031.py  ← ❌ 非推奨（CSV版）
├── main.py                        ← ✅ Streamlitアプリ
├── simulation_mysql_result.txt   ← ✅ 最新の結果
└── Book1.csv                      ← ❌ 古いデータ
```

## まとめ

✅ **問題解決完了**

1. ✅ データソースをMySQLに統一
2. ✅ 前倒し配送が正しく動作
3. ✅ CSV出力に「前倒し配送」列を追加
4. ✅ シミュレーションとStreamlitアプリが同じ結果

**次のステップ**: Streamlitアプリで計画を作成し、CSV出力して確認してください！
